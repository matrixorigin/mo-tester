package io.mo.result;

import io.mo.cases.SqlCommand;
import io.mo.constant.RESULT;
import org.apache.log4j.Logger;

public class StmtResult {
    /**
     * result type, value can be:
     * 0,means result is type of ResultSet
     * 1,means result is type of ErrorMessage
     * 2,means result is NULL
     */
    private int type = RESULT.STMT_RESULT_TYPE_INIT;
    private SqlCommand command;

    private String errorMessage = null;
    private RSSet rsSet = null;

    // restore the orginal result text read from the test result file
    // if instance is generated by the real ResultSet from the jdbc, it does not
    // make any senses
    private String expectRSText = null;

    private static Logger LOG = Logger.getLogger(StmtResult.class.getName());

    public StmtResult() {
    }

    public StmtResult(RSSet rsSet) {
        setRsSet(rsSet);
    }

    public boolean equals(StmtResult stmtResult) {
        if (this.type != stmtResult.getType()) {
            return false;
        } else {
            if (this.type == RESULT.STMT_RESULT_TYPE_ERROR) {
                if (this.errorMessage == null) {
                    if (stmtResult.getErrorMessage() != null) {
                        return false;
                    }
                }

                if (stmtResult.getErrorMessage() == null) {
                    if (this.errorMessage != null) {
                        return false;
                    }
                }

                if (!this.errorMessage.trim().equals(stmtResult.getErrorMessage().trim())) {
                    return false;
                }
            }

            if (this.type == RESULT.STMT_RESULT_TYPE_SET) {
                if (this.rsSet == null) {
                    if (stmtResult.getRsSet() != null) {
                        return false;
                    }
                }

                if (stmtResult.getRsSet() == null) {
                    if (this.rsSet != null) {
                        return false;
                    }
                }

                if (this.rsSet.getAbnormalError() != null || stmtResult.getRsSet().getAbnormalError() != null) {
                    return false;
                }

                // System.out.println("act : " + stmtResult.getRsSet().toString());
                if (!this.rsSet.equals(stmtResult.getRsSet())) {
                    return false;
                }
            }
        }

        return true;
    }

    public boolean regularMatch(StmtResult stmtResult) {
        if (stmtResult.errorMessage == null || stmtResult.errorMessage.equalsIgnoreCase("")) {
            LOG.error("NULL or EMPTY can not regularly match the expected result");
            return false;
        }
        if (stmtResult.errorMessage.matches(this.errorMessage))
            return true;
        else {
            LOG.error(String.format("[%s] can not match : \n %s", stmtResult.errorMessage, this.errorMessage));
            return false;
        }
    }
    
    /**
     * Check if the actual result contains all the hint keywords
     * This is used for cases like EXPLAIN where we only want to verify certain keywords exist
     * rather than comparing the entire output
     * @param stmtResult the actual result
     * @param hintKeywords the list of keywords that must be present in the result
     * @return true if all keywords are found, false otherwise
     */
    public boolean hintMatch(StmtResult stmtResult, ArrayList<String> hintKeywords){
        if(hintKeywords == null || hintKeywords.isEmpty()){
            LOG.error("Hint keywords list is null or empty, cannot perform hint match");
            return false;
        }
        
        String actualContent = null;
        
        // Get the actual result content based on result type
        if(stmtResult.getType() == RESULT.STMT_RESULT_TYPE_SET){
            if(stmtResult.getRsSet() == null){
                LOG.error("Actual result set is null, cannot perform hint match");
                return false;
            }
            actualContent = stmtResult.getRsSet().toString();
        } else if(stmtResult.getType() == RESULT.STMT_RESULT_TYPE_ERROR){
            actualContent = stmtResult.getErrorMessage();
        } else if(stmtResult.getType() == RESULT.STMT_RESULT_TYPE_NONE){
            LOG.error("Actual result is NONE type, cannot perform hint match");
            return false;
        } else {
            actualContent = stmtResult.toString();
        }
        
        if(actualContent == null || actualContent.isEmpty()){
            LOG.error("Actual result content is null or empty, cannot perform hint match");
            return false;
        }
        
        // Check if all hint keywords are present in the actual result
        for(String keyword : hintKeywords){
            if(!actualContent.contains(keyword)){
                LOG.error(String.format("Hint keyword [%s] not found in actual result", keyword));
                return false;
            }
        }
        
        LOG.debug(String.format("All hint keywords %s found in actual result", hintKeywords));
        return true;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public String getErrorMessage() {
        return errorMessage;
    }

    public void setErrorMessage(String errorMessage) {
        this.errorMessage = errorMessage;
    }

    public RSSet getRsSet() {
        return rsSet;
    }

    public void setRsSet(RSSet rsSet) {
        if (rsSet == null) {
            this.type = RESULT.STMT_RESULT_TYPE_NONE;
            return;
        }
        this.rsSet = rsSet;
        this.type = RESULT.STMT_RESULT_TYPE_SET;
        if (this.command != null) {
            connectSetAndCommand();
        }
        if (rsSet.getAbnormalError() != null) {
            this.type = RESULT.STMT_RESULT_TYPE_ABNORMAL;
        }
    }

    private void connectSetAndCommand() {
        this.rsSet.setCommand(this.command);
        // add sort key indexes
        for (int i = 0; i < command.getSortKeyIndexs().size(); i++) {
            this.rsSet.addSortKeyIndex(command.getSortKeyIndexs().get(i));
        }
    }

    public String getExpectRSText() {
        return expectRSText;
    }

    public void setExpectRSText(String expectRSText) {
        this.expectRSText = expectRSText;
    }

    public void setCommand(SqlCommand command) {
        this.command = command;
        if (this.rsSet != null) {
            connectSetAndCommand();
        }
    }

    public String toString() {
        if (this.type == RESULT.STMT_RESULT_TYPE_SET) {
            if (rsSet == null)
                return null;
            return rsSet.toString();
        }

        else if (this.type == RESULT.STMT_RESULT_TYPE_ERROR)
            return errorMessage;

        else if (this.type == RESULT.STMT_RESULT_TYPE_NONE)
            return null;

        else if (this.type == RESULT.STMT_RESULT_TYPE_ABNORMAL)
            return rsSet.getAbnormalError();
        else
            return expectRSText;
    }

}
