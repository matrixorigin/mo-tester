package io.mo.result;

import io.mo.cases.SqlCommand;
import io.mo.constant.RESULT;
import lombok.Getter;
import lombok.Setter;
import org.apache.log4j.Logger;

public class StmtResult {
    private static Logger LOG = Logger.getLogger(StmtResult.class.getName());

    /**
     * result type, value can be:
     * 0,means result is type of ResultSet
     * 1,means result is type of ErrorMessage
     * 2,means result is NULL
     */
    @Getter
    @Setter
    private int type = RESULT.STMT_RESULT_TYPE_INIT;
    
    // 保留自定义 setter，因为有额外逻辑
    @Getter
    private SqlCommand command;

    @Getter
    @Setter
    private String errorMessage = null;
    
    // 保留自定义 setter，因为有额外逻辑
    @Getter
    private RSSet rsSet = null;

    // restore the orginal result text read from the test result file
    // if instance is generated by the real ResultSet from the jdbc, it does not
    // make any senses
    @Getter
    @Setter
    private String expectRSText = null;

    public StmtResult() {
    }

    public StmtResult(RSSet rsSet) {
        setRsSet(rsSet);
    }

    public boolean equals(StmtResult stmtResult) {
        if (this.type != stmtResult.getType()) {
            return false;
        } else {
            if (this.type == RESULT.STMT_RESULT_TYPE_ERROR) {
                if (this.errorMessage == null) {
                    if (stmtResult.getErrorMessage() != null) {
                        return false;
                    }
                }

                if (stmtResult.getErrorMessage() == null) {
                    if (this.errorMessage != null) {
                        return false;
                    }
                }

                if (!this.errorMessage.trim().equals(stmtResult.getErrorMessage().trim())) {
                    return false;
                }
            }

            if (this.type == RESULT.STMT_RESULT_TYPE_SET) {
                if (this.rsSet == null) {
                    if (stmtResult.getRsSet() != null) {
                        return false;
                    }
                }

                if (stmtResult.getRsSet() == null) {
                    if (this.rsSet != null) {
                        return false;
                    }
                }

                if (this.rsSet.getAbnormalError() != null || stmtResult.getRsSet().getAbnormalError() != null) {
                    return false;
                }

                // System.out.println("act : " + stmtResult.getRsSet().toString());
                if (!this.rsSet.equals(stmtResult.getRsSet())) {
                    return false;
                }
            }
        }

        return true;
    }

    public boolean regularMatch(StmtResult stmtResult) {
        if (stmtResult.errorMessage == null || stmtResult.errorMessage.equalsIgnoreCase("")) {
            LOG.error("NULL or EMPTY can not regularly match the expected result");
            return false;
        }
        if (stmtResult.errorMessage.matches(this.errorMessage))
            return true;
        else {
            LOG.error(String.format("[%s] can not match : \n %s", stmtResult.errorMessage, this.errorMessage));
            return false;
        }
    }
    

    public void setRsSet(RSSet rsSet) {
        if (rsSet == null) {
            this.type = RESULT.STMT_RESULT_TYPE_NONE;
            return;
        }
        this.rsSet = rsSet;
        this.type = RESULT.STMT_RESULT_TYPE_SET;
        if (this.command != null) {
            connectSetAndCommand();
        }
        if (rsSet.getAbnormalError() != null) {
            this.type = RESULT.STMT_RESULT_TYPE_ABNORMAL;
        }
    }

    private void connectSetAndCommand() {
        this.rsSet.setCommand(this.command);
        // add sort key indexes
        for (int i = 0; i < command.getSortKeyIndexs().size(); i++) {
            this.rsSet.addSortKeyIndex(command.getSortKeyIndexs().get(i));
        }
    }


    public void setCommand(SqlCommand command) {
        this.command = command;
        if (this.rsSet != null) {
            connectSetAndCommand();
        }
    }

    public String toString() {
        if (this.type == RESULT.STMT_RESULT_TYPE_SET) {
            if (rsSet == null)
                return null;
            return rsSet.toString();
        }

        else if (this.type == RESULT.STMT_RESULT_TYPE_ERROR)
            return errorMessage;

        else if (this.type == RESULT.STMT_RESULT_TYPE_NONE)
            return null;

        else if (this.type == RESULT.STMT_RESULT_TYPE_ABNORMAL)
            return rsSet.getAbnormalError();
        else
            return expectRSText;
    }

}
